AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Provision an instance of the Javabuilder service. Empty the ContentBucket before deleting this Stack.
Parameters:
  BaseDomainName:
    Type: String
    Description: Base domain name.
  BaseDomainNameHostedZonedID:
    Type: String
    Description: AWS Route53 Hosted Zone ID for base domain name.
  SubDomainName:
    Type: String
    Description: Sub domain name for javabuilder service.
  LogBucket:
    Type: String
    Default: cdo-logs.s3.amazonaws.com
  ProvisionedConcurrentExecutions:
    Type: Number
    Description: The amount of provisioned concurrency to allocate for the BuildAndRunJavaProject Lambda.
    MinValue: 1
    Default: 1
  ReservedConcurrentExecutions:
    Type: Number
    Description: The amount of concurrency to allow for the BuildAndRunJavaProject Lambda.
    MinValue: 1
    Default: 3
  LimitPerHour:
    Type: Number
    Description: The number of Javabuilder invocations allowed per user per hour.
    MinValue: 1
    Default: 10
  LimitPerDay:
    Type: Number
    Description: The number of Javabuilder invocations allowed per user per day.
    MinValue: 1
    Default: 40
<%
JAVALAB_APP_TYPES = %w(
  Theater
  Neighborhood
  Console
  Playground
)
-%>
Globals:
  Function:
    Runtime: ruby2.7
    Timeout: 30
    MemorySize: 256
    Tracing: Active
Conditions:
  IsDevCondition: !Equals [!Ref BaseDomainName, "dev-code.org"]
Resources:
# Note: We can't update the name of a DomainName resource once it has been created because the
# domain name itself has already been provisioned. When we change from javabuilderbeta to
# javabuilder, we should update the WebSocket resources here to use the prefix "WebSocket"
<%{
  Http: {Prefix: "Http", Suffix: "-http"},
  WebSocket: {Prefix: "", Suffix: ""},
}.each do |apiName, config| -%>
  <%=config[:Prefix]%>Domain:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Sub "${BaseDomainName}."
      Name: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt <%=config[:Prefix]%>DomainName.RegionalDomainName
        HostedZoneId: !GetAtt <%=config[:Prefix]%>DomainName.RegionalHostedZoneId

  <%=config[:Prefix]%>DomainName:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainName: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      DomainNameConfigurations:
        - EndpointType: REGIONAL
          CertificateArn: !Ref <%=config[:Prefix]%>Certificate
          CertificateName: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"

  <%=config[:Prefix]%>Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"
          HostedZoneId: !Ref BaseDomainNameHostedZonedID

  <%=config[:Prefix]%>DomainNameAPIMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    DependsOn:
      - <%=config[:Prefix]%>Domain
    Properties:
      ApiId: !Ref <%=apiName%>API
      DomainName: !Sub "${SubDomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      Stage: !Ref <%=apiName%>Stage

<%end -%>
  HttpAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${SubDomainName}-http.${BaseDomainName}"
      ProtocolType: HTTP

  PutRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpAPI
      RouteKey: PUT /seedsources/sources.json
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref HttpAuthorizer
      OperationName: PutRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref PutIntegration

  PutSourcesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Puts user sources into the S3 bucket
      CodeUri: api-gateway-routes/
      Handler: api_gateway_put_function.lambda_handler
      Role: !ImportValue JavabuilderLambdaExecutionRole
      Environment:
        Variables:
          CONTENT_BUCKET_NAME: !Ref ContentBucket

  PutSourcesPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - HttpAPI
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PutSourcesFunction
      Principal: apigateway.amazonaws.com

  PutIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref HttpAPI
      Description: PUT Integration
      # Integration method must be POST for AWS_PROXY integrations even though we're PUTting into an S3 bucket
      IntegrationMethod: POST
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PutSourcesFunction.Arn}/invocations
      PayloadFormatVersion: 2.0

  HttpStageLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/apigateway/accesslog/${SubDomainName}-http.${BaseDomainName}"

  HttpStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      # Using AutoDeploy rather than a Deployment resource (as we do with the WebSocket API) because
      # the Deployment resource doesn't seem to work with HTTP APIs.
      AutoDeploy: true
      StageName: Prod
      Description: Prod Stage
      ApiId: !Ref HttpAPI
      DefaultRouteSettings:
        DetailedMetricsEnabled: true
      AccessLogSettings:
        DestinationArn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/apigateway/accesslog/${SubDomainName}-http.${BaseDomainName}"
        # TODO: Also log authorizer status code, authorizer error message, Javabuilder session id, and Origin.
        Format: '{
            "host": "$context.domainName",
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "requestTime": "$context.requestTime",
            "httpMethod": "$context.httpMethod",
            "caller": "$context.identity.caller",
            "routeKey": "$context.routeKey",
            "status": "$context.status",
            "protocol": "$context.protocol",
            "userAgent": "$context.identity.userAgent",
            "responseLength":"$context.responseLength",
            "contextErrorMessage": "$context.error.message",
            "contextErrorMessageString": "$context.error.messageString",
            "integrationError": "$context.integration.error",
            "authorizerError": "$context.authorizer.error"
          }'

  HttpAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      ApiId: !Ref HttpAPI
      AuthorizerCredentialsArn:
        Fn::ImportValue: JavabuilderAPIGatewayRole
      AuthorizerPayloadFormatVersion: 2.0
      AuthorizerResultTtlInSeconds: 0
      AuthorizerType: REQUEST
      AuthorizerUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HttpAuthorizerLambda.Arn}/invocations"
      IdentitySource:
        - "$request.querystring.Authorization"
      Name: HttpAuthorizer

  WebSocketAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${SubDomainName}.${BaseDomainName}"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $connect
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref WebSocketAuthorizer
      OperationName: ConnectRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref ConnectInteg

  WebSocketAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      ApiId: !Ref WebSocketAPI
      AuthorizerType: REQUEST
      AuthorizerUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebsocketAuthorizerLambda.Arn}/invocations"
      IdentitySource:
        - route.request.querystring.Authorization
      Name: WebSocketAuthorizer

  ConnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      Description: Connect Integration
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations

  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $default
      AuthorizationType: NONE
      OperationName: DefaultRoute
      Target:
        Fn::Join:
          - /
          - - integrations
            - Ref: DefaultIntegration

  DefaultIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      Description: Lambda Proxy Integration
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations"

  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $disconnect
      AuthorizationType: NONE
      OperationName: DisconnectRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref DisconnectInteg

  DisconnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      Description: Disconnect Integration
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations

  WebSocketDeployment:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn:
      - ConnectRoute
      - DefaultRoute
      - DisconnectRoute
    Properties:
      ApiId: !Ref WebSocketAPI

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: Prod
      Description: Prod Stage
      DeploymentId: !Ref WebSocketDeployment
      ApiId: !Ref WebSocketAPI
      DefaultRouteSettings:
        DetailedMetricsEnabled: true
        LoggingLevel: INFO
        DataTraceEnabled: true
      AccessLogSettings:
        DestinationArn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/apigateway/accesslog/${SubDomainName}.${BaseDomainName}"
        # TODO: Also log authorizer status code, authorizer error message, Javabuilder session id, and Origin.
        Format: '{
            "host": "$context.domainName",
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "requestTime": "$context.requestTime",
            "method": "$context.httpMethod",
            "caller": "$context.identity.caller",
            "eventType": "$context.eventType",
            "routeKey": "$context.routeKey",
            "status": "$context.status",
            "connectionId": "$context.connectionId",
            "protocol": "$context.protocol",
            "userAgent": "$context.identity.userAgent",
            "contextErrorMessage": "$context.error.message",
            "contextErrorMessageString": "$context.error.messageString",
            "integrationError": "$context.integration.error",
            "authorizerError": "$context.authorizer.error"
          }'

  StartSessionAndRelayMessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Starts the long-running Lambda that compiles and runs a JavaLab project and relays messages to it from the JavaLab client.
      CodeUri: api-gateway-routes/
      Handler: api_gateway_proxy_function.lambda_handler
      Role: !ImportValue JavabuilderLambdaExecutionRole
      Environment:
        Variables:
          # The Logical ID of the BuildAndRun Lambda Alias, which is generated by SAM because AutoPublishAlias is enabled
          # has a predictable format: <function‑LogicalId>Alias<alias‑name>
          # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-generated-resources-function.html#sam-specification-generated-resources-function-autopublishalias
<%JAVALAB_APP_TYPES.each do | name | -%>
          BUILD_AND_RUN_<%=name.upcase%>_PROJECT_LAMBDA_ARN: !Ref BuildAndRunJava<%=name%>ProjectFunctionAliaslive
<%end -%>

  StartSessionAndRelayMessagesPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref StartSessionAndRelayMessagesFunction
      Principal: apigateway.amazonaws.com

# AWS does not seem to be case sensitive, but is case aware. Therefore, we can't update from
# Websocket here to WebSocket as is used elsewhere when updating an existing stack. Updating this is
# a step we should take when we create our non-beta environment from scratch. At that point, we
# should also update uses of HttpAPI and WebSocketAPI to be HttpApi and WebSocketApi, respectively,
# to match the AWS standard elsewhere in this template. Example: "AWS::ApiGatewayV2::ApiMapping"
#
# Note: hourly and daily limit values provided to both authorizers here as environment variables,
# but are only needed in the HTTP authorizer.
<%{
  Http: {
    LambdaName: "Http",
    Handler: "http_authorizer_function",
    Description: "'Authorize PUT by decoding JWT in Authorization querystring parameter.'"
  },
  WebSocket: {
    LambdaName: "Websocket",
    Handler: "websocket_authorizer_function",
    Description: "'Authorize WebSocket connect by decoding JWT in Authorization querystring parameter.'"
  },
}.each do |name, config| -%>
  <%=config[:LambdaName]%>AuthorizerLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: <%=config[:Handler]%>.lambda_handler
      CodeUri: javabuilder-authorizer/
      Description: <%=config[:Description]%>
      Timeout: 3
      Role: !ImportValue JavabuilderLambdaExecutionRole
      Environment:
        Variables:
          rsa_pub_development: '-----BEGIN RSA PUBLIC KEY-----\n MIIBigKCAYEAsAThWFxY9BsbUNQDhpMu+KrhClJTmNLxvcDhQEH0Q9XnixcWJ+/c\n
            3LP2FEhigh4s8Q1JK7QufZy6MbOYb4tt1zyuoy+3/gBd0H4g2CJv/M1kU4+hxmsf\n VDa0JfYftwEm0mh2gPG1tqh+kGLHavy7ucZQ1pKZt2u8VJkAvccZai+GkPia8hEk\n
            UKL+N1/czTcl6Hk5jZ49iRBkwqkDcA4mkVEjNSvQuv+XnK/82+501+HH3gW3+u8X\n dqp6ByG33qSgkc6Q7IuzPo3huNUmg/I9pv2UmnUwMuYwg0OLIA+n2vnptfHZiysK\n
            pH7am13oDai/Ym5OXvkgYLvxpKdm4dspsHFEhqcLpAi6/a9r3/j8eOe1OovRYS9F\n D93FWO/R/WVPf4y6ivWABv8m9kdIkON7jX8mFtxU1QmLrKEMQrJ7kLHaWTyO4Aa3\n
            +pVMuC5D6l9s30vvv42aYRUaevCoxYJWckkrawulrKCLLAS/jr+HWvtRebOMDfVa\n Q6kmTDXoCz5RAgMBAAE=\n
            -----END RSA PUBLIC KEY-----'
          rsa_pub_levelbuilder: '-----BEGIN RSA PUBLIC KEY-----\n MIIBigKCAYEAsI0yli9nfrWQwCSfNgqyZr58YZdzPF4+loo4tJ+E0+dCLw98g8V2\n
            WP5KhSlii9+HqOeUT6qrm+pyHWpbdLyu1TV+Ni9Ge0vBVFNEkeCcSygqtUYc0UDg\n Q0jsEQpOEc1OxgoM2IyPgJA7P8ZKNT53n5eKitZyqjbjOPNzrrp3RnkQatKndPju\n
            dIDIuuFASalSngYZAZ3UUwX0spjsghevdRZtX+WGJspusFlPCH2uMOPlHy9M9eXq\n CBcnodnmKKOGGTsVzxLsBMiiy6KsxUzw4h0hXoQzJQ1ekroIhkA/kez6jkaT6oPU\n
            AyPv2X1ISmjedWpEA24kEtpJ0/f6yZYQnbuV+XUoij4zzGBCIaOv9xM5UDxC/OYB\n yiDi37gTB4wDjoLOcegTVmofLqtXoglPPbvWak1zfNsM1B2rPOvIBHqXlwTh5cV1\n
            rvW6Xm31/uN2LFhGzNU1YT4g816UZGeY2jgAgtluQFcw5lVgWHIOf/qGdwRjKmE0\n 0hKh01Y/DqJDAgMBAAE=\n
            -----END RSA PUBLIC KEY-----'
          rsa_pub_production: '-----BEGIN RSA PUBLIC KEY-----\n MIIBigKCAYEA0crU7JS0T8U3n4rRKRbWuKqM3vLbUdUKk+SY3EPXUE6LGRBSKApK\n
            olFNE9eFfzwQUiIhwC43ORWVWckMrb8+C4GLqR5R+c8MWjhVcGNv9gdVDvPH8pUx\n 14rDMrHCgafVW7gmSOwOCFtv5RZeDTGRNroWHFNhx61trlPxutN6vP4qB1zJGutY\n
            UVnLxwTVcMbbhFwFlj6g+CjnTChqSH7+hyfLf/jRKh4yKi7+IrngzkuX9DY1Vj9n\n Zub0GmPKTIAcxW6ZKQ39qJ7Wzw1gqo+Yaa6Wge+7/lPY0J23jItGda0VNTwzi3dl\n
            +M3D4/sKi9Jhb3FbP7PY1ODzxpEUQHHlbY2g0RMEdUi2w42zoUxEL1rUGMsUqQUO\n nq+VZqNdaFvH8G92xmKr+Tzva9kH1izEHMhEmW/KSpXDd3s+xGztzLI+zOLhuv61\n
            RI4Dv8EugxWsABZt1y0fEBxkc74FIirKPOpqZKSjrquCnVsAxJslCfW7Yh7IEkqd\n paVaB7WFPFIjAgMBAAE=\n
            -----END RSA PUBLIC KEY-----'
          rsa_pub_staging: '-----BEGIN RSA PUBLIC KEY-----\n MIIBigKCAYEAqlwz8q7LHMB2PoQF5+HcuZBecWF259clP3CN6gl465Z83KUQmdLq\n
            9riok1KSzP2+LlkPsbeqSpc7H5DJBydkMHItJXmDF3lpfVWOiHNuiW5KrPCD8BrU\n SYgPViqAqR1Vt3SaOFwoi0QAYtDhz15L9JubRXXiTcIKsvd8Nhiwz1CA0fWtUDfD\n
            OQDowrhLJrHEtn+TWOjHBxPHMnzmTPKaWiktBTMWetHnAPuWprziBmLS+yN1N83A\n RxdlfLvgT/bWQNn3BVB53bzxawzyGNv+OVlBauVlnrBQfhTU2dasx8h+7lSXHZzW\n
            SrC/8oPWN4q/IMGA6kiuao+LrqDqyhwoZzKOoeZtn+1xda8v2qLWxpSKmgIdXCeD\n 5mAhk2ybrIXo5vwlizKjCO+zwWECf4uKtWWXBKKqqnz7hZN75E3NX5QQEK6tuzQF\n
            HCEalY6cg+q12QzaQjV6XM5OV+1fYMwPLNVv1Ocjc/oPpfA+WqPbOd8/OM3bq4f4\n Bp4+XTzk0hDTAgMBAAE=\n
            -----END RSA PUBLIC KEY-----'
          rsa_pub_test: '-----BEGIN RSA PUBLIC KEY-----\n MIIBigKCAYEAuZNRSIeapdlDcD0i/lLfw6o7MHTRow5umZyDW8DQ75LcFwbDvOcP\n
            GD5oSMPuPA6Yc7OYXB08JvHUq1llrxJNP0UGgBwVFZ0Fl1mpzb9Fp0pklw5Q3/tS\n yVH4WCVnFhF0QEFcWJ4WU00DGzrFbVUJw4hHIays0TOmUtCVD4pe6BAz89wf80cy\n
            SKb+2ABiqC5Qbc9Ki6CLXiOMlXEpG8uYzcmVtFUrA3gyz1Ux+oT+xQ8G2CjL+7Au\n LhBd9Na7zPEsB5sAwHzzZHCPx+/wTKbrT0FfKJRqc0vYOvWFFkeoBcZcx9/+DnGs\n
            82lnuUHekrW+j3sCimbhFPM+HDXJI03g5Uv698oiSXp8+dqB7VzGD4ux9lwlB6Dr\n 3+8Pz/c7t8me0CJquotr7p7kYtoPo6kK9NL74zu4KsAcotDvRw8tHRs3cZ/X3KEl\n
            vb2YtSsq4ecf7sZeQgSbeZ6PdwEIBp0dl5AG6SgIWPcweNwmZmJg917i0lSGgWxW\n OlIo9VurlVd3AgMBAAE=\n
            -----END RSA PUBLIC KEY-----'
          rsa_pub_adhoc: '-----BEGIN RSA PUBLIC KEY-----\n MIIBCgKCAQEAoGqR0M5qbi+XSH9XCAEQhlEVXbUaIFYXnw0Sxk7YhfAWLpUQMiHW\n
            DWJemqP54cJ0GPjhHTvL/BdsURkA5ZXpApXWvzQ0kr0kfp7NvC7o2LnB/U78xSsG\n /uwBz+xaCmW71X4uxcXnKT9AFLRRaB1z7RLZoE8NhJErRS+25UqbTBYVdsZkvsIy\n
            ZUbJMN3hMFIFP4smAtjkKqguLJPFdcMij7WFDjL5kPQpxuc4RSq97iXRODIBjW1B\n zdN9ZpGRA4MDOu3BtLC69PwoFrSULAzlUmC5fJIwpaXoRGZEYRMQThlJ9VsRGwTG\n
            JTJJ4dWJ2cw61prbeU/HVCWD8OaNumz9tQIDAQAB\n
            -----END RSA PUBLIC KEY-----'
          limit_per_hour: !Ref LimitPerHour
          limit_per_day: !Ref LimitPerDay

  <%=name%>AuthorizerPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - <%=name%>Authorizer
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref <%=config[:LambdaName]%>AuthorizerLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${<%=name%>API}/authorizers/${<%=name%>Authorizer}"

<%end -%>
  ChangeJavaRuntimeDirectoryLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
        - java11
      ContentUri: org-code-javabuilder/change_runtime_directory
      Description: Change Java runtime to launch from the writeable /tmp directory to enable student projects to write files more easily.
      LayerName: change-java-runtime-directory

  FontConfigurationLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
        - java11
      ContentUri: org-code-javabuilder/font_config.zip
      Description: Add a font configuration file to enable use of fonts.
      LayerName: font-configuration

<%{
  Theater: {MemorySize: 1769, Timeout: 90},
  Neighborhood: {MemorySize: 512, Timeout: 90},
  Console: {MemorySize: 512, Timeout: 90},
  Playground: {MemorySize: 512, Timeout: 300}
}.each do |name, config| -%>
  BuildAndRunJava<%=name%>ProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref FontConfigurationLayer
        - !Ref ChangeJavaRuntimeDirectoryLayer
      Handler: org.code.javabuilder.LambdaRequestHandler::handleRequest
      Runtime: java11
      CodeUri: org-code-javabuilder/lib/build/distributions/lib.zip
      AutoPublishAlias: live
      ReservedConcurrentExecutions: !Ref ReservedConcurrentExecutions
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref ProvisionedConcurrentExecutions
      Description: Compile and execute a JavaLab <%=name%> project.
      MemorySize: <%=config[:MemorySize]%>
      Timeout: <%=config[:Timeout]%>
      EventInvokeConfig:
        MaximumRetryAttempts: 0
      Role:
        Fn::ImportValue: JavabuilderLambdaExecutionRole
      Environment:
        Variables:
          AWS_LAMBDA_EXEC_WRAPPER: /opt/change_runtime_directory
          CONTENT_BUCKET_NAME: !Ref ContentBucket
          CONTENT_BUCKET_URL: !Sub "https://${ContentDomain}"
<%end -%>

  ContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If [IsDevCondition, !Sub "cdo-dev-${SubDomainName}-content", !Sub "cdo-${SubDomainName}-content"]
      CorsConfiguration:
        CorsRules:
          - AllowedMethods: [GET, PUT]
            AllowedOrigins: ['*']
            AllowedHeaders: ['*']
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'
      LifecycleConfiguration:
        Rules:
          - Id: ExpirationRule
            Status: Enabled
            ExpirationInDays: 1

  ContentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ContentBucket
      PolicyDocument:
        Statement:
        - Action: ['s3:GetObject']
          Effect: Allow
          Resource: !Sub "arn:aws:s3:::${ContentBucket}/*"
          Principal: '*'

  ContentAPICertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "${SubDomainName}-content.${BaseDomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "${SubDomainName}-content.${BaseDomainName}"
          HostedZoneId: !Ref BaseDomainNameHostedZonedID

  ContentDomain:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Sub "${BaseDomainName}."
      Name: !Sub "${SubDomainName}-content.${BaseDomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt ContentCDN.DomainName
        HostedZoneId: Z2FDTNDATAQYW2 # static ID for cloudfront aliases

  ContentCDN:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Aliases: [!Sub "${SubDomainName}-content.${BaseDomainName}"]
        ViewerCertificate:
          AcmCertificateArn: !Ref ContentAPICertificate
          MinimumProtocolVersion: TLSv1
          SslSupportMethod: sni-only
        CustomErrorResponses:
          - ErrorCode: 403
            ErrorCachingMinTTL: 0
        # TODO: enable logging when LogBucket is set up
        # Logging:
        #   Bucket: !Ref LogBucket
        #   IncludeCookies: false
        #   Prefix: !Sub "${SubDomainName}-content.${BaseDomainName}"
        Origins:
          - Id: ContentBucket
            DomainName: !GetAtt ContentBucket.DomainName
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: ContentBucket
          AllowedMethods: [DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT]
          Compress: true
          DefaultTTL: 0
          ForwardedValues: {QueryString: true}
          ViewerProtocolPolicy: redirect-to-https

  HighConcurrentExecutionsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubDomainName}_high_concurrent_executions"
      AlarmDescription: !Sub |
          This will page the DOTD if javabuilder usage exceeds 50 concurrent
          executions for 10 minutes. Occasional spikes are expected, but
          long-running high usage is an indication of an attack. Go to the
          following URLs and set reserved concurrency to 10 immediately
<%JAVALAB_APP_TYPES.each do | name | -%>
          https://console.aws.amazon.com/lambda/home?region=${AWS::Region}#/functions/${BuildAndRunJava<%=name%>ProjectFunction}/edit/concurrency?tab=configure
<%end -%>
          Then post in #ap-csa-dev.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
          - !If [IsDevCondition, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-dev-test", !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:CDO-Urgent"]
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 10
      DatapointsToAlarm: 10
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: Concurrent Executions Across All Lambdas
          ReturnData: true
          Expression: SUM(METRICS())
<%{Theater: "m2", Neighborhood: "m3", Console: "m4", Playground: "m5"}.each do |name, id| -%>
        - Id: <%=id%>
          ReturnData: false
          MetricStat:
              Metric:
                  Namespace: AWS/Lambda
                  MetricName: ConcurrentExecutions
                  Dimensions:
                      - Name: FunctionName
                        Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
              Period: 60
              Stat: Maximum
<%end -%>
<%JAVALAB_APP_TYPES.each do | name | -%>

  <%=name%>HighSevereErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubDomainName}_<%=name.downcase%>_high_severe_error_rate"
      AlarmDescription: Send page if Javabuilder severe error rate exceeds 10% for 20
          minutes. Occasional spikes are expected, but a sustained high error rate
          is an indication of an outage.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
          - !If [IsDevCondition, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-dev-test", !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:Javabuilder-high-error-rate"]
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 4
      DatapointsToAlarm: 4
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
          - Id: e1
            Label: Error Rate (%)
            ReturnData: true
            Expression: (m1 / m2) * 100
          - Id: m1
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: Javabuilder
                    MetricName: Javabuilder <%=name%> "SEVERE" errors
                    Dimensions: []
                Period: 300
                Stat: Sum
          - Id: m2
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Invocations
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum

  <%=name%>HighErrorRateAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubDomainName}_build_and_run_<%=name.downcase%>_lambda_error_rate"
      AlarmDescription: Error rate in Javabuilder's <%=name%> build and run lambda (the core of
          Javabuilder, which executes student <%=name%> code) exceeded 10% for four
          consecutive 5 minute periods.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
          - !If [IsDevCondition, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-dev-test", !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-build-and-run-lambda-error-rate"]
      InsufficientDataActions: []
      Dimensions: []
      EvaluationPeriods: 4
      DatapointsToAlarm: 4
      Threshold: 25
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
          - Id: e1
            Label: Errors / Invocations
            ReturnData: true
            Expression: (m1 / m2) * 100
          - Id: m1
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Errors
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
          - Id: m2
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Invocations
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
<%end -%>
# We use shortened versions of names for partition keys (eg, user_id),
# but values will be a concatenation of the domain name and appropriate ID.
# Values will look something like:
# studio.code.org#123456 (user_requests table)
# studio.code.org#UserId#123456 (blocked_users table)
<%
  DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME = 'user_id'
  DOMAIN_AND_TOKEN_ID_COMPOSITE_ATTRIBUTE_NAME = 'token_id'
  DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME = 'section_owner_id'
  ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME = 'issued_at'
  READ_CAPACITY_PER_SECOND = 1000
  WRITE_CAPACITY_PER_SECOND = 1000
-%>
  BlockedUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubDomainName}_blocked_users"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: <%=READ_CAPACITY_PER_SECOND%>
        WriteCapacityUnits: <%=WRITE_CAPACITY_PER_SECOND%>
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
  TokenStatusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubDomainName}_tokens"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_TOKEN_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: <%=READ_CAPACITY_PER_SECOND%>
        WriteCapacityUnits: <%=WRITE_CAPACITY_PER_SECOND%>
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_TOKEN_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
  UserRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubDomainName}_user_requests"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_TOKEN_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: <%=READ_CAPACITY_PER_SECOND%>
        WriteCapacityUnits: <%=WRITE_CAPACITY_PER_SECOND%>
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_TOKEN_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          AttributeType: N
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
  TeacherAssociatedRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubDomainName}_teacher_associated_requests"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: <%=READ_CAPACITY_PER_SECOND%>
        WriteCapacityUnits: <%=WRITE_CAPACITY_PER_SECOND%>
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          AttributeType: N
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true
Outputs:
  JavabuilderURL:
    Value:
      Fn::Sub: wss://${SubDomainName}.${BaseDomainName}
