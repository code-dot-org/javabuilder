AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Provision an instance of the Javabuilder service. Empty the ContentBucket before deleting this Stack.
Parameters:
  BaseDomainName:
    Type: String
    Description: Base domain name (e.g. 'code.org' in 'javabuilder.code.org').
  BaseDomainNameHostedZonedID:
    Type: String
    Description: AWS Route53 Hosted Zone ID for base domain name.
  SubdomainName:
    Type: String
    Description: Subdomain name for javabuilder service (e.g. 'javabuilder' in 'javabuilder.code.org').
  # LogBucket:
  #   Type: String
  #   Default: cdo-logs.s3.amazonaws.com
  ProvisionedConcurrentExecutions:
    Type: Number
    Description: The amount of provisioned concurrency to allocate for the BuildAndRunJavaProject Lambda.
    MinValue: 1
    Default: 1
  ReservedConcurrentExecutions:
    Type: Number
    Description: The amount of concurrency to allow for the BuildAndRunJavaProject Lambda.
    MinValue: 1
    Default: 3
  LimitPerHour:
    Type: Number
    Description: The number of Javabuilder invocations allowed per user per hour.
    MinValue: 1
    Default: 50
  LimitPerDay:
    Type: Number
    Description: The number of Javabuilder invocations allowed per user per day.
    MinValue: 1
    Default: 150
  TeacherLimitPerHour:
    Type: Number
    Description: The number of Javabuilder invocations allowed for all students in a classroom per hour.
    MinValue: 1
    Default: 5000
  StageName:
    Type: String
    Description: The default stage name in the API Gateway APIs
    Default: Prod
  SilenceAlerts:
    Type: String
    AllowedValues: [true, false]
    Description: If alerts should be silenced on this instance
    Default: false
<%
JAVALAB_APP_TYPES = %w(
  Theater
  Neighborhood
  Console
)
-%>
Globals:
  Function:
    Runtime: ruby2.7
    Timeout: 30
    MemorySize: 256
    Tracing: Active
Conditions:
  IsDevCondition: !Equals [!Ref BaseDomainName, "dev-code.org"]
  SilenceAlertsCondition: !Or [Condition: IsDevCondition, !Equals [!Ref SilenceAlerts, "true"]]
Resources:
# Note: We can't update the name of a DomainName resource once it has been created because the
# domain name itself has already been provisioned. When we change from javabuilderbeta to
# javabuilder, we should update the WebSocket resources here to use the prefix "WebSocket"
<%{
  Http: {Prefix: "Http", Suffix: "-http"},
  WebSocket: {Prefix: "", Suffix: ""},
}.each do |apiName, config| -%>
  <%=config[:Prefix]%>Domain:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Sub "${BaseDomainName}."
      Name: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt <%=config[:Prefix]%>DomainName.RegionalDomainName
        HostedZoneId: !GetAtt <%=config[:Prefix]%>DomainName.RegionalHostedZoneId

  <%=config[:Prefix]%>DomainName:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainName: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      DomainNameConfigurations:
        - EndpointType: REGIONAL
          CertificateArn: !Ref <%=config[:Prefix]%>Certificate
          CertificateName: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"

  <%=config[:Prefix]%>Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"
          HostedZoneId: !Ref BaseDomainNameHostedZonedID

  <%=config[:Prefix]%>DomainNameApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    DependsOn:
      - <%=config[:Prefix]%>Domain
    Properties:
      ApiId: !Ref <%=apiName%>Api
      DomainName: !Sub "${SubdomainName}<%=config[:Suffix]%>.${BaseDomainName}"
      Stage: !Ref <%=apiName%>Stage

<%end -%>
  HttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${SubdomainName}-http.${BaseDomainName}"
      ProtocolType: HTTP

  PutRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpApi
      RouteKey: PUT /seedsources/sources.json
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref HttpAuthorizer
      OperationName: PutRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref PutIntegration

  PutSourcesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Puts user sources into the S3 bucket
      CodeUri: api-gateway-routes/
      Handler: api_gateway_put_function.lambda_handler
      Role: !ImportValue JavabuilderPutSourcesLambdaRole
      Environment:
        Variables:
          CONTENT_BUCKET_NAME: !Ref ContentBucket

  PutSourcesPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - HttpApi
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref PutSourcesFunction
      Principal: apigateway.amazonaws.com

  PutIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref HttpApi
      Description: PUT Integration
      # Integration method must be POST for AWS_PROXY integrations even though we're PUTting into an S3 bucket
      IntegrationMethod: POST
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${PutSourcesFunction.Arn}/invocations
      PayloadFormatVersion: 2.0

  HttpStageLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/apigateway/accesslog/${SubdomainName}-http.${BaseDomainName}"

  HttpStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      # Using AutoDeploy rather than a Deployment resource (as we do with the WebSocket API) because
      # the Deployment resource doesn't seem to work with HTTP APIs.
      AutoDeploy: true
      StageName: !Sub "${StageName}"
      Description: The stage to deploy
      ApiId: !Ref HttpApi
      DefaultRouteSettings:
        DetailedMetricsEnabled: true
      AccessLogSettings:
        DestinationArn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/apigateway/accesslog/${SubdomainName}-http.${BaseDomainName}"
        # TODO: Also log authorizer status code, authorizer error message, Javabuilder session id, and Origin.
        Format: '{
            "host": "$context.domainName",
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "requestTime": "$context.requestTime",
            "httpMethod": "$context.httpMethod",
            "caller": "$context.identity.caller",
            "routeKey": "$context.routeKey",
            "status": "$context.status",
            "protocol": "$context.protocol",
            "userAgent": "$context.identity.userAgent",
            "responseLength":"$context.responseLength",
            "contextErrorMessage": "$context.error.message",
            "contextErrorMessageString": "$context.error.messageString",
            "integrationError": "$context.integration.error",
            "authorizerError": "$context.authorizer.error"
          }'

  HttpAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      ApiId: !Ref HttpApi
      AuthorizerCredentialsArn:
        Fn::ImportValue: JavabuilderAPIGatewayRole
      AuthorizerPayloadFormatVersion: 2.0
      AuthorizerResultTtlInSeconds: 0
      AuthorizerType: REQUEST
      AuthorizerUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${HttpAuthorizerLambda.Arn}/invocations"
      IdentitySource:
        - "$request.querystring.Authorization"
      Name: HttpAuthorizer

  WebSocketApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${SubdomainName}.${BaseDomainName}"
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"

  ConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $connect
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref WebSocketAuthorizer
      OperationName: ConnectRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref ConnectInteg

  WebSocketAuthorizer:
    Type: AWS::ApiGatewayV2::Authorizer
    Properties:
      ApiId: !Ref WebSocketApi
      AuthorizerType: REQUEST
      AuthorizerUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketAuthorizerLambda.Arn}/invocations"
      IdentitySource:
        - route.request.querystring.Authorization
      Name: WebSocketAuthorizer

  ConnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      Description: Connect Integration
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations

  DefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $default
      AuthorizationType: NONE
      OperationName: DefaultRoute
      Target:
        Fn::Join:
          - /
          - - integrations
            - Ref: DefaultIntegration

  DefaultIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      Description: Lambda Proxy Integration
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations"

  DisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketApi
      RouteKey: $disconnect
      AuthorizationType: NONE
      OperationName: DisconnectRoute
      Target: !Join
        - '/'
        - - 'integrations'
          - !Ref DisconnectInteg

  DisconnectInteg:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketApi
      Description: Disconnect Integration
      IntegrationType: AWS_PROXY
      IntegrationUri:
        Fn::Sub:
          arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${StartSessionAndRelayMessagesFunction.Arn}/invocations

  WebSocketDeployment:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn:
      - ConnectRoute
      - DefaultRoute
      - DisconnectRoute
    Properties:
      ApiId: !Ref WebSocketApi

  WebSocketStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: !Sub "${StageName}"
      Description: The stage to deploy
      DeploymentId: !Ref WebSocketDeployment
      ApiId: !Ref WebSocketApi
      DefaultRouteSettings:
        DetailedMetricsEnabled: true
        LoggingLevel: INFO
        DataTraceEnabled: false
      AccessLogSettings:
        DestinationArn: !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/apigateway/accesslog/${SubdomainName}.${BaseDomainName}"
        # TODO: Also log authorizer status code, authorizer error message, Javabuilder session id, and Origin.
        Format: '{
            "host": "$context.domainName",
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "requestTime": "$context.requestTime",
            "method": "$context.httpMethod",
            "caller": "$context.identity.caller",
            "eventType": "$context.eventType",
            "routeKey": "$context.routeKey",
            "status": "$context.status",
            "connectionId": "$context.connectionId",
            "protocol": "$context.protocol",
            "userAgent": "$context.identity.userAgent",
            "contextErrorMessage": "$context.error.message",
            "contextErrorMessageString": "$context.error.messageString",
            "integrationError": "$context.integration.error",
            "authorizerError": "$context.authorizer.error"
          }'

  StartSessionAndRelayMessagesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Description: Starts the long-running Lambda that compiles and runs a JavaLab project and relays messages to it from the JavaLab client.
      CodeUri: api-gateway-routes/
      Handler: api_gateway_proxy_function.lambda_handler
      Role: !ImportValue JavabuilderSessionManagerMessageRelayLambdaRole
      Environment:
        Variables:
          # The Logical ID of the BuildAndRun Lambda Alias, which is generated by SAM because AutoPublishAlias is enabled
          # has a predictable format: <function‑LogicalId>Alias<alias‑name>
          # https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-generated-resources-function.html#sam-specification-generated-resources-function-autopublishalias
<%JAVALAB_APP_TYPES.each do | name | -%>
          BUILD_AND_RUN_<%=name.upcase%>_PROJECT_LAMBDA_ARN: !Ref BuildAndRunJava<%=name%>ProjectFunctionAliaslive
<%end -%>

  StartSessionAndRelayMessagesPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketApi
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref StartSessionAndRelayMessagesFunction
      Principal: apigateway.amazonaws.com

# Note: hourly and daily limit values provided to both authorizers here as environment variables,
# but are only needed in the HTTP authorizer.
# Both authorizers need to access the token_status DynamoDB table, but only the HTTP authorizer
# needs to access to the other tables.
<%{
  Http: {
    LambdaName: "Http",
    Handler: "http_authorizer_function",
    Description: "'Authorize PUT by decoding JWT in Authorization querystring parameter.'"
  },
  WebSocket: {
    LambdaName: "WebSocket",
    Handler: "websocket_authorizer_function",
    Description: "'Authorize WebSocket connect by decoding JWT in Authorization querystring parameter.'"
  },
}.each do |name, config| -%>
  <%=config[:LambdaName]%>AuthorizerLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: <%=config[:Handler]%>.lambda_handler
      CodeUri: javabuilder-authorizer/
      Description: <%=config[:Description]%>
      Timeout: 3
      Role: !ImportValue JavabuilderAuthorizerLambdaRole
      Environment:
        Variables:
          limit_per_hour: !Ref LimitPerHour
          limit_per_day: !Ref LimitPerDay
          teacher_limit_per_hour: !Ref TeacherLimitPerHour
          blocked_users_table: !Ref BlockedUsersTable
          token_status_table: !Ref TokenStatusTable
          user_requests_table: !Ref UserRequestsTable
          teacher_associated_requests_table: !Ref TeacherAssociatedRequestsTable

  <%=name%>AuthorizerPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - <%=name%>Authorizer
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref <%=config[:LambdaName]%>AuthorizerLambda
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${<%=name%>Api}/authorizers/${<%=name%>Authorizer}"

<%end -%>
  ChangeJavaRuntimeDirectoryLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
        - java11
      ContentUri: org-code-javabuilder/change_runtime_directory
      Description: Change Java runtime to launch from the writeable /tmp directory to enable student projects to write files more easily.
      LayerName: change-java-runtime-directory

  FontConfigurationLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes:
        - java11
      ContentUri: org-code-javabuilder/font_config.zip
      Description: Add a font configuration file to enable use of fonts.
      LayerName: font-configuration

<%{
  Theater: {MemorySize: 1769, Timeout: 90},
  Neighborhood: {MemorySize: 512, Timeout: 120},
  Console: {MemorySize: 512, Timeout: 90}
}.each do |name, config| -%>
  BuildAndRunJava<%=name%>ProjectFunction:
    Type: AWS::Serverless::Function
    Properties:
      Layers:
        - !Ref FontConfigurationLayer
        - !Ref ChangeJavaRuntimeDirectoryLayer
      Handler: org.code.javabuilder.LambdaRequestHandler::handleRequest
      Runtime: java11
      CodeUri: org-code-javabuilder/lib/build/distributions/lib.zip
      AutoPublishAlias: live
      ReservedConcurrentExecutions: !Ref ReservedConcurrentExecutions
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: !Ref ProvisionedConcurrentExecutions
      Description: Compile and execute a JavaLab <%=name%> project.
      MemorySize: <%=config[:MemorySize]%>
      Timeout: <%=config[:Timeout]%>
      EventInvokeConfig:
        MaximumRetryAttempts: 0
      Role:
        Fn::ImportValue: JavabuilderBuildAndRunLambdaRole
      Environment:
        Variables:
          AWS_LAMBDA_EXEC_WRAPPER: /opt/change_runtime_directory
          CONTENT_BUCKET_NAME: !Ref ContentBucket
          CONTENT_BUCKET_URL: !Sub "https://${ContentDomain}"
          API_ENDPOINT: !Sub
            - "https://${ApiId}.execute-api.${AWS::Region}.amazonaws.com/${StageName}"
            - ApiId: !Ref WebSocketApi
          UNHEALTHY_CONTAINERS_TABLE_NAME: !Ref UnhealthyContainersTable
<%end -%>

  ContentBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !If [IsDevCondition, !Sub "cdo-dev-${SubdomainName}-content", !Sub "cdo-${SubdomainName}-content"]
      CorsConfiguration:
        CorsRules:
          - AllowedMethods: [GET, PUT]
            AllowedOrigins: ['*']
            AllowedHeaders: ['*']
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: 'AES256'
      LifecycleConfiguration:
        Rules:
          - Id: ExpirationRule
            Status: Enabled
            ExpirationInDays: 1

  ContentBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ContentBucket
      PolicyDocument:
        Statement:
        - Action: ['s3:GetObject']
          Effect: Allow
          Resource: !Sub "arn:aws:s3:::${ContentBucket}/*"
          Principal: '*'

  ContentApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Sub "${SubdomainName}-content.${BaseDomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Sub "${SubdomainName}-content.${BaseDomainName}"
          HostedZoneId: !Ref BaseDomainNameHostedZonedID

  ContentDomain:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Sub "${BaseDomainName}."
      Name: !Sub "${SubdomainName}-content.${BaseDomainName}"
      Type: A
      AliasTarget:
        DNSName: !GetAtt ContentCDN.DomainName
        HostedZoneId: Z2FDTNDATAQYW2 # static ID for cloudfront aliases

  ContentCDN:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Aliases: [!Sub "${SubdomainName}-content.${BaseDomainName}"]
        ViewerCertificate:
          AcmCertificateArn: !Ref ContentApiCertificate
          MinimumProtocolVersion: TLSv1
          SslSupportMethod: sni-only
        CustomErrorResponses:
          - ErrorCode: 403
            ErrorCachingMinTTL: 0
        # TODO: enable logging when LogBucket is set up
        # Logging:
        #   Bucket: !Ref LogBucket
        #   IncludeCookies: false
        #   Prefix: !Sub "${SubdomainName}-content.${BaseDomainName}"
        Origins:
          - Id: ContentBucket
            DomainName: !GetAtt ContentBucket.DomainName
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: ContentBucket
          AllowedMethods: [DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT]
          Compress: true
          DefaultTTL: 0
          ForwardedValues: {QueryString: true}
          ViewerProtocolPolicy: redirect-to-https

<%JAVALAB_APP_TYPES.each do | name | -%>
<%{
  TenPercentSevereErrorRateAlarm: {Threshold: 10, AlarmName: 'ten_percent_severe_error_rate'},
  NinetyPercentSevereErrorRateAlarm: {Threshold: 90, AlarmName: 'ninety_percent_severe_error_rate'},
}.each do |alarmTitle, config| -%>
  <%=name%><%=alarmTitle%>:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_<%=config[:AlarmName]%>"
      AlarmDescription: Severe error rate in Javabuilder's <%=name%> build and run lambda (the core of
          Javabuilder, which executes student <%=name%> code) exceeded <%=config[:Threshold]%>% for four
          consecutive 5 minute periods.
      ActionsEnabled: false
      EvaluationPeriods: 4
      DatapointsToAlarm: 4
      Threshold: <%=config[:Threshold]%>
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
          - Id: e1
            Label: Error Rate (%)
            ReturnData: true
            Expression: (m1 / m2) * 100
          - Id: m1
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: Javabuilder
                    MetricName: SevereError
                    Dimensions:
                      - Name: functionName
                        Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
          - Id: m2
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Invocations
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
<%end%>


<%{
  TwentyFivePercentErrorRateAlarm: {Threshold: 25, AlarmName: 'twenty_five_percent_error_rate'},
  NinetyPercentErrorRateAlarm: {Threshold: 90, AlarmName: 'ninety_percent_error_rate'},
}.each do |alarmTitle, config| -%>
  <%=name%><%=alarmTitle%>:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_<%=config[:AlarmName]%>"
      AlarmDescription: Error rate in Javabuilder's <%=name%> build and run lambda (the core of
          Javabuilder, which executes student <%=name%> code) exceeded <%=config[:Threshold]%>% for four
          consecutive 5 minute periods.
      ActionsEnabled: false
      EvaluationPeriods: 4
      DatapointsToAlarm: 4
      Threshold: <%=config[:Threshold]%>
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Metrics:
          - Id: e1
            Label: Errors / Invocations
            ReturnData: true
            Expression: ((m1 - m3) / m2) * 100
          - Id: m1
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Errors
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
          - Id: m2
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Invocations
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: Sum
          - Id: m3
            ReturnData: false
            MetricStat:
                Metric:
                    Namespace: AWS/Lambda
                    MetricName: Duration
                    Dimensions:
                        - Name: FunctionName
                          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
                Period: 300
                Stat: TC(89000:)
<%end%>

  <%=name%>SlowCleanupTimeAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_slow_cleanup_time"
      AlarmDescription: Average cleanup time in Javabuilder's <%=name%> build and run lambda was high for at 
        least 15 out of the last 20 minutes. Investigate if there has been a performance regression.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
        - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-slow-performance"]
      InsufficientDataActions: []
      MetricName: CleanupTime
      Namespace: Javabuilder
      Statistic: Average
      Dimensions:
        - Name: functionName
          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
      EvaluationPeriods: 20
      DatapointsToAlarm: 15
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Threshold: 200
      Period: 60
  
  <%=name%>SlowColdBootTimeAlarm:    
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_slow_cold_boot_time"
      AlarmDescription: Average cold boot time in Javabuilder's <%=name%> build and run lambda was high for at 
        least 15 out of the last 20 minutes. Investigate if there has been a performance regression.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
        - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-slow-performance"]
      InsufficientDataActions: []
      MetricName: ColdBootTime
      Namespace: Javabuilder
      Statistic: Average
      Dimensions:
        - Name: functionName
          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
      EvaluationPeriods: 20
      DatapointsToAlarm: 15
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Threshold: 10500
      Period: 60

  <%=name%>SlowInitializationTimeAlarm:    
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_slow_initialization_time"
      AlarmDescription: Average initialization time in Javabuilder's <%=name%> build and run lambda was high for at 
        least 15 out of the last 20 minutes. Investigate if there has been a performance regression.
      ActionsEnabled: true
      OKActions: []
      AlarmActions:
        - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-slow-performance"]
      InsufficientDataActions: []
      MetricName: InitializationTime
      Namespace: Javabuilder
      Statistic: Average
      Dimensions:
        - Name: functionName
          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
      EvaluationPeriods: 20
      DatapointsToAlarm: 15
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      Threshold: 5000
      Period: 60

  
  <%=name%>SlowTransitionTimeAlarm:    
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_slow_transition_time"
        AlarmDescription: Average transition time in Javabuilder's <%=name%> build and run lambda was high for at 
          least 15 out of the last 20 minutes. Investigate if there has been a performance regression.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-slow-performance"]
        InsufficientDataActions: []
        MetricName: TransitionTime
        Namespace: Javabuilder
        Statistic: Average
        Dimensions:
          - Name: functionName
            Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
        EvaluationPeriods: 20
        DatapointsToAlarm: 15
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        Threshold: 2500
        Period: 60

  <%=name%>MinimumUsageAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_minimum_usage"
        AlarmDescription: This alarm is to be used as part of a composite alarm, not by itself.
            It triggers if the usage is above a minimum threshold, so we do not alarm on error
            rates if we have very low usage.
        ActionsEnabled: false
        MetricName: Invocations
        Namespace: AWS/Lambda
        Statistic: Sum
        Dimensions:
            - Name: FunctionName
              Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
        Period: 300
        EvaluationPeriods: 4
        DatapointsToAlarm: 4
        Threshold: 100
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
  
  <%=name%>SevereErrorRateAlarm:
    Type: AWS::CloudWatch::CompositeAlarm
    DependsOn:
      - <%=name%>TenPercentSevereErrorRateAlarm
      - <%=name%>MinimumUsageAlarm
      - <%=name%>ElevatedSevereErrorRateAlarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_severe_error_rate"
        AlarmDescription: Alarm if Javabuilder severe error rate exceeds 10% every 5 minutes for 20
          minutes and there are at least 100 requests every 5 minutes. 
          Occasional spikes are expected, but a sustained elevated severe error rate is an indication of an issue.
          Severe errors are generated and emitted by our code. Please follow the instructions in this document to mitigate
          https://docs.google.com/document/d/1bHvV6pvUcwxgZpw0YWBmxFggQL5KqYx9zwolwkZhjU8/edit#bookmark=id.2gh4dxmz643n
        ActionsEnabled: true
        AlarmActions:
            - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:Javabuilder-high-error-rate"]
        AlarmRule: !Sub "ALARM(${SubdomainName}_<%=name.downcase%>_ten_percent_severe_error_rate) AND 
            ALARM(${SubdomainName}_<%=name.downcase%>_minimum_usage)"
        InsufficientDataActions: []
        OKActions: []
        ActionsSuppressor: !Sub "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${SubdomainName}_<%=name.downcase%>_elevated_severe_error_rate"
        ActionsSuppressorWaitPeriod: 120
        ActionsSuppressorExtensionPeriod: 120

  <%=name%>ElevatedSevereErrorRateAlarm:
    Type: AWS::CloudWatch::CompositeAlarm
    DependsOn:
      - <%=name%>NinetyPercentSevereErrorRateAlarm
      - <%=name%>MinimumUsageAlarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_elevated_severe_error_rate"
        AlarmDescription: Alarm if Javabuilder severe error rate exceeds 90% every 5 minutes for 20
          minutes and there are at least 100 requests every 5 minutes. 
          Occasional spikes are expected, but a sustained high severe error rate is an indication of an outage.
          Severe errors are generated and emitted by our code. Please follow the instructions in this document to mitigate
          https://docs.google.com/document/d/1bHvV6pvUcwxgZpw0YWBmxFggQL5KqYx9zwolwkZhjU8/edit#bookmark=id.2gh4dxmz643n
        ActionsEnabled: true
        AlarmActions:
            - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:CDO-Urgent"]
        AlarmRule: !Sub "ALARM(${SubdomainName}_<%=name.downcase%>_ninety_percent_severe_error_rate) AND 
            ALARM(${SubdomainName}_<%=name.downcase%>_minimum_usage)"
        InsufficientDataActions: []
        OKActions: []
  
  <%=name%>ErrorRateAlarm:
    Type: AWS::CloudWatch::CompositeAlarm
    DependsOn:
      - <%=name%>TwentyFivePercentErrorRateAlarm
      - <%=name%>MinimumUsageAlarm
      - <%=name%>ElevatedErrorRateAlarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_error_rate"
        AlarmDescription: Alarm if Javabuilder severe error rate exceeds 25% every 5 minutes for 20
          minutes and there are at least 100 requests every 5 minutes. 
          Occasional spikes are expected, but a sustained elevated error rate is an indication of an issue.
          Errors are generated by the Lambda system. Please follow the instructions in this document to mitigate
          https://docs.google.com/document/d/1bHvV6pvUcwxgZpw0YWBmxFggQL5KqYx9zwolwkZhjU8/edit#bookmark=id.2gh4dxmz643n
        ActionsEnabled: true
        AlarmActions:
            - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:Javabuilder-high-error-rate"]
        AlarmRule: !Sub "ALARM(${SubdomainName}_<%=name.downcase%>_twenty_five_percent_error_rate) AND 
            ALARM(${SubdomainName}_<%=name.downcase%>_minimum_usage)"
        InsufficientDataActions: []
        OKActions: []
        ActionsSuppressor: !Sub "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${SubdomainName}_<%=name.downcase%>_elevated_error_rate"
        ActionsSuppressorWaitPeriod: 120
        ActionsSuppressorExtensionPeriod: 120

  <%=name%>ElevatedErrorRateAlarm:
    Type: AWS::CloudWatch::CompositeAlarm
    DependsOn:
      - <%=name%>NinetyPercentErrorRateAlarm
      - <%=name%>MinimumUsageAlarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_elevated_error_rate"
        AlarmDescription: Alarm if Javabuilder error rate exceeds 90% every 5 minutes for 20
          minutes and there are at least 100 requests every 5 minutes. 
          Occasional spikes are expected, but a sustained high error rate is an indication of an outage.
          Errors are generated by the Lambda system. Please follow the instructions in this document to mitigate
          https://docs.google.com/document/d/1bHvV6pvUcwxgZpw0YWBmxFggQL5KqYx9zwolwkZhjU8/edit#bookmark=id.2gh4dxmz643n
        ActionsEnabled: true
        AlarmActions:
            - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:CDO-Urgent"]
        AlarmRule: !Sub "ALARM(${SubdomainName}_<%=name.downcase%>_ninety_percent_error_rate) AND 
            ALARM(${SubdomainName}_<%=name.downcase%>_minimum_usage)"
        InsufficientDataActions: []
        OKActions: []
  
  <%=name%>HighConcurrentExecutionsAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${SubdomainName}_<%=name.downcase%>_high_concurrent_executions"
      AlarmDescription: !Sub |
          Alarm if javabuilder usage exceeds 400 concurrent
          executions for 10 minutes. Occasional spikes are expected, but
          long-running high usage is an indication of an attack. Page the student learning
          team for further investigation. See this doc for investigation steps
          https://docs.google.com/document/d/1bHvV6pvUcwxgZpw0YWBmxFggQL5KqYx9zwolwkZhjU8/edit#bookmark=id.xs1gcuxrw6ze
      ActionsEnabled: true
      AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:CDO-Urgent"]
      EvaluationPeriods: 10
      DatapointsToAlarm: 10
      Period: 60
      Threshold: 400
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      MetricName: ConcurrentExecutions
      Namespace: AWS/Lambda
      Statistic: Maximum
      Dimensions:
        - Name: FunctionName
          Value: !Ref BuildAndRunJava<%=name%>ProjectFunction
<%end -%>

# We use shortened versions of names for partition keys (eg, user_id),
# but values will be a concatenation of the domain name and appropriate ID.
# Values will look something like:
# studio.code.org#123456 (user_requests table)
# studio.code.org#UserId#123456 (blocked_users table)
<%
  DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME = 'user_id'
  DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME = 'section_owner_id'
  TOKEN_ID_ATTRIBUTE_NAME = 'token_id'
  ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME = 'issued_at'
  TIME_TO_LIVE_ATTRIBUTE_NAME = 'ttl'
  CONTAINER_ID_AND_TRIGGER_COMPOSITE_ATTRIBUTE_NAME = 'container_id'
-%>
  BlockedUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubdomainName}_blocked_users"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true

  TokenStatusTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubdomainName}_tokens"
      KeySchema:
        - AttributeName: <%=TOKEN_ID_ATTRIBUTE_NAME%>
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: <%=TOKEN_ID_ATTRIBUTE_NAME%>
          AttributeType: S
      TimeToLiveSpecification:
        AttributeName: <%=TIME_TO_LIVE_ATTRIBUTE_NAME%>
        Enabled: true

  UserRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubdomainName}_user_requests"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_USER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          AttributeType: N
      TimeToLiveSpecification:
        AttributeName: <%=TIME_TO_LIVE_ATTRIBUTE_NAME%>
        Enabled: true

  TeacherAssociatedRequestsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${SubdomainName}_teacher_associated_requests"
      KeySchema:
        - AttributeName: <%=DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          KeyType: HASH
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: <%=DOMAIN_AND_SECTION_OWNER_ID_COMPOSITE_ATTRIBUTE_NAME%>
          AttributeType: S
        - AttributeName: <%=ISSUED_AT_TIMESTAMP_ATTRIBUTE_NAME%>
          AttributeType: N
      TimeToLiveSpecification:
        AttributeName: <%=TIME_TO_LIVE_ATTRIBUTE_NAME%>
        Enabled: true

  UnhealthyContainersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: !Sub "${SubdomainName}_unhealthy_containers"
        KeySchema:
          - AttributeName: <%=CONTAINER_ID_AND_TRIGGER_COMPOSITE_ATTRIBUTE_NAME%>
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: <%=CONTAINER_ID_AND_TRIGGER_COMPOSITE_ATTRIBUTE_NAME%>
            AttributeType: S

  HighUsersBlockedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_high_users_blocked"
        AlarmDescription: Unusually high number of users being newly blocked by our throttling
            thresholds.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-throttling"]
        InsufficientDataActions: []
        MetricName: NewUserBlocked
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref HttpAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 100
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching

  ClassroomBlockedAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_classroom_blocked"
        AlarmDescription: A classroom was newly blocked by our threshold. Investigate if this is classroom should be blocked.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-throttling"]
        InsufficientDataActions: []
        MetricName: NewClassroomBlocked
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref HttpAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching

  HighUnknownTokensAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_high_unknown_tokens"
        AlarmDescription: Websocket authorizer is receiving connection requests using
            tokens that did not pass through the HTTP authorizer first.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-token-errors"]
        InsufficientDataActions: []
        MetricName: TokenUnknownId
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref WebSocketAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 100
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching

  HighUnvettedTokensAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_high_unvetted_tokens"
        AlarmDescription: Websocket authorizer is receiving connection requests using
            tokens that were observed but not vetted as valid by the HTTP authorizer.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-token-errors"]
        InsufficientDataActions: []
        MetricName: TokenNotVetted
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref WebSocketAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 100
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching

  WebsocketHighUsedTokensAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_websocket_high_used_tokens"
        AlarmDescription: Websocket authorizer is receiving connection requests using
            tokens have already been used.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-token-errors"]
        InsufficientDataActions: []
        MetricName: TokenUsed
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref WebSocketAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 100
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching

  HttpHighUsedTokensAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
        AlarmName: !Sub "${SubdomainName}_http_high_used_tokens"
        AlarmDescription: HTTP authorizer is receiving connection requests using
            tokens have already been used.
        ActionsEnabled: true
        OKActions: []
        AlarmActions:
          - !If [SilenceAlertsCondition, !Ref AWS::NoValue, !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:javabuilder-high-token-errors"]
        InsufficientDataActions: []
        MetricName: TokenUsed
        Namespace: Javabuilder
        Statistic: Sum
        Dimensions:
            - Name: functionName
              Value: !Ref HttpAuthorizerLambda
        Period: 60
        EvaluationPeriods: 1
        DatapointsToAlarm: 1
        Threshold: 100
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching

Outputs:
  JavabuilderURL:
    Value:
      Fn::Sub: wss://${SubdomainName}.${BaseDomainName}
